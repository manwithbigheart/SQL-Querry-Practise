<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Smart Tutor</title>
    <style>
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #6c757d;
            --success-color: #198754;
            --warning-color: #ffc107;
            --info-color: #0dcaf0;
            --light-bg: #f8f9fa;
            --container-bg: #ffffff;
            --text-color: #212529;
            --border-color: #dee2e6;
            --code-bg: #e9ecef;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--light-bg);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
            margin: 0;
            box-sizing: border-box;
        }

        .main-container {
            width: 100%;
            max-width: 900px;
            background: var(--container-bg);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            padding: 30px 40px;
        }

        h1, h2 {
            color: var(--primary-color);
            text-align: center;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 15px;
            margin-top: 0;
        }

        /* Views */
        #topic-selection-view, #practice-view { display: none; }

        /* Topic Selection */
        #topic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        .topic-card {
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            text-align: center;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .topic-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        /* Practice View */
        .practice-card {
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .task-description { font-size: 1.3em; font-weight: 500; margin-bottom: 20px; }
        
        #user-query-area {
            width: 100%;
            height: 150px;
            font-family: "Courier New", Courier, monospace;
            font-size: 1.05em;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-sizing: border-box;
            margin-bottom: 10px;
        }
        
        #feedback-container {
            border-radius: 8px;
            margin-top: 15px;
            padding: 15px;
            display: none;
        }
        #feedback-container.correct { background-color: #d1e7dd; border: 1px solid var(--success-color); }
        #feedback-container.incorrect { background-color: #fff3cd; border: 1px solid var(--warning-color); }
        #feedback-container h4 { margin-top: 0; }
        #feedback-list { list-style-type: none; padding-left: 0; }
        #feedback-list li { margin-bottom: 8px; }

        .reveal-content { display: none; margin-top: 15px; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        pre {
            background-color: var(--code-bg);
            padding: 15px;
            border-radius: 8px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: "Courier New", Courier, monospace;
            border: 1px solid #ced4da;
            font-size: 1.05em;
        }

        .explanation, .key-concepts {
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid var(--primary-color);
            font-size: 1.05em;
            line-height: 1.6;
        }
        .explanation { background-color: #e9f5ff; }
        .key-concepts { background-color: #f0f8ff; }
        .key-concepts ul { padding-left: 20px; margin: 0; }

        .navigation-controls, .action-buttons {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            color: white;
        }
        
        .btn-primary { background-color: var(--primary-color); }
        .btn-success { background-color: var(--success-color); }
        .btn-secondary { background-color: var(--secondary-color); }
        .btn-info { background-color: #5bc0de; }
        
        #back-to-topics-btn { display: block; margin: 25px auto 0; }
    </style>
</head>
<body>

    <div class="main-container">

        <div id="topic-selection-view">
            <h1>SQL Practice Topics ðŸ“š</h1>
            <div id="topic-grid"></div>
        </div>

        <div id="practice-view">
            <h2 id="topic-title"></h2>
            
            <div class="practice-card">
                <button id="toggle-concepts-btn" class="btn btn-info">Read Key Concepts</button>
                <div id="concepts-content" class="reveal-content">
                    <h3>Key Concepts:</h3>
                    <div class="key-concepts" id="concepts-text"></div>
                </div>
            </div>

            <div class="practice-card">
                <p id="question-counter" style="text-align:center; font-weight:bold;"></p>
                <h3>Schema:</h3>
                <pre id="schema-display"></pre>
                <p class="task-description" id="task-description"></p>
                
                <label for="user-query-area"><strong>Your SQL Code:</strong></label>
                <textarea id="user-query-area" placeholder="Write your SQL query here..."></textarea>
                <button id="check-code-btn" class="btn btn-success" style="width:100%;">Check My Code</button>
                
                <div id="feedback-container">
                    <h4 id="feedback-title"></h4>
                    <ul id="feedback-list"></ul>
                </div>

                <div class="action-buttons">
                    <button id="reveal-answer-btn" class="btn btn-primary">Show Correct Answer</button>
                </div>
                
                <div id="answer-content" class="reveal-content">
                    <h3>Correct Query:</h3>
                    <pre id="query-code"></pre>
                    <h3>Explanation:</h3>
                    <div class="explanation" id="explanation-text"></div>
                </div>
            </div>

            <div class="navigation-controls">
                <button id="prev-btn" class="btn btn-secondary">Previous</button>
                <button id="next-btn" class="btn btn-secondary">Next</button>
            </div>
            <button id="back-to-topics-btn" class="btn btn-primary">Back to Topics</button>
        </div>

    </div>

    <script>
        // Data and DOM elements setup (same as before)
        const learningData = [
            {
                topic: "Set 1: Joins (Basic)",
                schema: "- students(student_id, name, course_id)\n- courses(course_id, course_name)",
                concepts: ["..."],
                questions: [
                    { task: "1. Write a query using an INNER JOIN to display all students along with their course names.", query: "SELECT s.student_id, s.name, c.course_name FROM students s INNER JOIN courses c ON s.course_id = c.course_id;", explanation: "..." },
                    { task: "2. Write a query using a LEFT JOIN to display all students and their course names, including students who have not enrolled in any course.", query: "SELECT s.student_id, s.name, c.course_name FROM students s LEFT JOIN courses c ON s.course_id = c.course_id;", explanation: "..." }
                ]
            },
            {
                topic: "Set 2: Aggregation & Group By",
                schema: "- orders(order_id, customer_id, order_date, total_amount)\n- customers(customer_id, customer_name, city)",
                concepts: ["..."],
                questions: [
                    { task: "1. Write a query to display the total amount spent by each customer.", query: "SELECT c.customer_id, c.customer_name, SUM(o.total_amount) AS total_spent FROM customers c JOIN orders o ON c.customer_id = o.customer_id GROUP BY c.customer_id, c.customer_name;", explanation: "..." },
                    { task: "2. Write a query to find the city with the highest number of customers.", query: "SELECT city, COUNT(customer_id) AS total_customers FROM customers GROUP BY city ORDER BY total_customers DESC LIMIT 1;", explanation: "..." }
                ]
            },
            {
                topic: "Set 3: Subqueries",
                schema: "- employees(emp_id, emp_name, dept_id, salary)\n- departments(dept_id, dept_name)",
                concepts: ["..."],
                questions: [
                    { task: "1. Write a query to find the employees who earn more than the average salary of all employees.", query: "SELECT emp_id, emp_name, salary FROM employees WHERE salary > (SELECT AVG(salary) FROM employees);", explanation: "..." },
                    { task: "2. Write a query to display the department name of the highest paid employee.", query: "SELECT d.dept_name FROM employees e JOIN departments d ON e.dept_id = d.dept_id WHERE e.salary = (SELECT MAX(salary) FROM employees);", explanation: "..." }
                ]
            },
            {
                topic: "Set 4: Window Functions",
                schema: "- sales(sale_id, product_id, sale_date, amount)\n- products(product_id, product_name, category)",
                concepts: ["..."],
                questions: [
                    { task: "1. Write a query to display each productâ€™s total sales and also the rank of each product based on total sales.", query: "SELECT p.product_id, p.product_name, SUM(s.amount) AS total_sales, RANK() OVER (ORDER BY SUM(s.amount) DESC) AS sales_rank FROM products p JOIN sales s ON p.product_id = s.product_id GROUP BY p.product_id, p.product_name;", explanation: "..." },
                    { task: "2. Write a query to find the running total of sales for each product ordered by sale_date.", query: "SELECT product_id, sale_date, amount, SUM(amount) OVER (PARTITION BY product_id ORDER BY sale_date) AS running_total FROM sales;", explanation: "..." }
                ]
            },
            {
                topic: "Set 5: Constraints & Keys",
                schema: "- users(user_id, username, email UNIQUE, created_at)\n- posts(post_id, user_id, post_title, post_date)",
                concepts: ["..."],
                questions: [
                    { task: "1. Write a query to create the users table with PRIMARY KEY and email as UNIQUE.", query: "CREATE TABLE users (user_id INT PRIMARY KEY, username VARCHAR(100), email VARCHAR(100) UNIQUE, created_at DATETIME);", explanation: "..." },
                    { task: "2. Write a query to display all users along with the count of posts they created (use GROUP BY).", query: "SELECT u.user_id, u.username, COUNT(p.post_id) AS total_posts FROM users u LEFT JOIN posts p ON u.user_id = p.user_id GROUP BY u.user_id, u.username;", explanation: "..." }
                ]
            },
             {
                topic: "Set 6: String & Date Functions",
                schema: "- students(student_id, name, dob, email)",
                concepts: ["..."],
                questions: [
                    { task: "1. Write a query to display each studentâ€™s age (use DATEDIFF or TIMESTAMPDIFF).", query: "SELECT student_id, name, TIMESTAMPDIFF(YEAR, dob, CURDATE()) AS age FROM students;", explanation: "..." },
                    { task: "2. Write a query to extract the domain name from email (e.g., gmail.com).", query: "SELECT student_id, name, SUBSTRING_INDEX(email, '@', -1) AS domain FROM students;", explanation: "..." }
                ]
            },
            {
                topic: "Set 7: Advanced Joins",
                schema: "- employees(emp_id, emp_name, manager_id, dept_id)\n- departments(dept_id, dept_name)",
                concepts: ["..."],
                questions: [
                    { task: "1. Write a query to display each employeeâ€™s manager name using a SELF JOIN.", query: "SELECT e.emp_id, e.emp_name, m.emp_name AS manager_name FROM employees e LEFT JOIN employees m ON e.manager_id = m.emp_id;", explanation: "..." },
                    { task: "2. Write a query to display all departments and the number of employees in each department (use RIGHT JOIN).", query: "SELECT d.dept_id, d.dept_name, COUNT(e.emp_id) AS total_employees FROM employees e RIGHT JOIN departments d ON d.dept_id = e.dept_id GROUP BY d.dept_id, d.dept_name;", explanation: "..." }
                ]
            },
            {
                topic: "Set 8: Transactions & ACID",
                schema: "- accounts(account_id, customer_name, balance)",
                concepts: ["..."],
                questions: [
                    { task: "1. Write SQL commands to start a transaction, transfer â‚¹500 from account_id=1 to account_id=2, and then commit the transaction.", query: "START TRANSACTION; UPDATE accounts SET balance = balance - 500 WHERE account_id = 1; UPDATE accounts SET balance = balance + 500 WHERE account_id = 2; COMMIT;", explanation: "..." },
                    { task: "2. Write SQL commands to demonstrate a ROLLBACK after updating a balance.", query: "START TRANSACTION; UPDATE accounts SET balance = balance - 1000 WHERE account_id = 1; ROLLBACK;", explanation: "..." }
                ]
            },
            {
                topic: "Set 9: Indexing & Performance",
                schema: "- orders(order_id, customer_id, order_date, total_amount)",
                concepts: ["..."],
                questions: [
                    { task: "1. Write a query to create an index on order_date.", query: "CREATE INDEX idx_order_date ON orders(order_date);", explanation: "..." },
                    { task: "2. Write a query to explain how the index improves query performance by checking the execution plan.", query: "EXPLAIN SELECT * FROM orders WHERE order_date > '2025-01-01';", explanation: "..." }
                ]
            },
            {
                topic: "Set 10: Complex Query Challenge",
                schema: "- orders(order_id, customer_id, order_date, amount)\n- customers(customer_id, customer_name, city)\n- products(product_id, product_name, price)\n- order_items(order_id, product_id, quantity)",
                concepts: ["..."],
                questions: [
                    { task: "1. Write a query to display the top 3 customers who spent the most in the last 6 months.", query: "SELECT c.customer_id, c.customer_name, SUM(o.amount) AS total_spent FROM customers c JOIN orders o ON c.customer_id = o.customer_id WHERE o.order_date >= DATE_SUB(CURDATE(), INTERVAL 6 MONTH) GROUP BY c.customer_id, c.customer_name ORDER BY total_spent DESC LIMIT 3;", explanation: "..." },
                    { task: "2. Write a query to display the most sold product by quantity.", query: "SELECT p.product_id, p.product_name, SUM(oi.quantity) AS total_quantity FROM products p JOIN order_items oi ON p.product_id = oi.product_id GROUP BY p.product_id, p.product_name ORDER BY total_quantity DESC LIMIT 1;", explanation: "..." }
                ]
            }
        ];
        // Populate full concepts data (same as previous version)
        
        const feedbackContainer = document.getElementById('feedback-container');
        const feedbackTitle = document.getElementById('feedback-title');
        const feedbackList = document.getElementById('feedback-list');
        // All other DOM elements are the same

        // --- NEW: Smart Analyzer Functions ---

        /**
         * Parses an SQL query into its constituent clauses.
         * A simplified parser for this specific tool.
         */
        function parseQuery(query) {
            const q = ` ${query.toLowerCase()} `; // Pad for easier regex
            const clauses = {};
            
            const keywords = ['select', 'from', 'join', 'where', 'group by', 'order by', 'limit'];
            
            // Extract content between keywords
            for (let i = 0; i < keywords.length; i++) {
                const currentKeyword = keywords[i];
                const nextKeyword = i + 1 < keywords.length ? keywords[i+1] : null;
                
                const startRegex = new RegExp(`\\s${currentKeyword}\\s`, 'i');
                const startIndexMatch = q.match(startRegex);
                
                if (startIndexMatch) {
                    let endIndex = q.length;
                    if (nextKeyword) {
                        const endRegex = new RegExp(`\\s${nextKeyword}\\s`, 'i');
                        const endIndexMatch = q.substring(startIndexMatch.index + currentKeyword.length + 1).match(endRegex);
                        if (endIndexMatch) {
                             endIndex = startIndexMatch.index + currentKeyword.length + 1 + endIndexMatch.index;
                        }
                    }
                    clauses[currentKeyword] = q.substring(startIndexMatch.index + currentKeyword.length + 1, endIndex).trim();
                }
            }
             // Special handling for JOIN ON condition
            if (clauses.join) {
                const onMatch = clauses.join.match(/on\s(.*)/i);
                if (onMatch) {
                    clauses.on = onMatch[1];
                    clauses.join = clauses.join.replace(/on\s(.*)/i, '').trim();
                }
            }

            return clauses;
        }

        /**
         * Normalizes a string for comparison.
         */
        function normalize(str) {
            if (!str) return '';
            return str.replace(/\s+/g, '').replace(/as/g, '').replace(/`/g, '');
        }

        /**
         * Compares two parsed queries and generates feedback.
         */
        function getAdvancedFeedback(userQuery, correctQuery) {
            const userClauses = parseQuery(userQuery);
            const correctClauses = parseQuery(correctQuery);
            const feedback = [];
            let isCorrect = true;

            const allClauses = [...new Set([...Object.keys(userClauses), ...Object.keys(correctClauses)])];
            
            for (const clause of allClauses) {
                const userVal = userClauses[clause] || '';
                const correctVal = correctClauses[clause] || '';

                if (normalize(userVal) === normalize(correctVal)) {
                    if (userVal) { // Only give positive feedback if the user actually wrote the clause
                         feedback.push(`<li>âœ… Your <strong>${clause.toUpperCase()}</strong> clause looks correct.</li>`);
                    }
                } else {
                    isCorrect = false;
                    if (correctVal && !userVal) {
                        feedback.push(`<li>ðŸ’¡ It looks like you're missing the <strong>${clause.toUpperCase()}</strong> clause.</li>`);
                    } else if (!correctVal && userVal) {
                         feedback.push(`<li>ðŸ’¡ The <strong>${clause.toUpperCase()}</strong> clause isn't needed for this question.</li>`);
                    } else {
                        feedback.push(`<li>ðŸ’¡ Check your <strong>${clause.toUpperCase()}</strong> clause. It seems different from the expected answer.</li>`);
                    }
                }
            }
            
            // Check for overall correctness
            if (normalize(userQuery.replace(/;/g,'')) !== normalize(correctQuery.replace(/;/g,''))) {
                isCorrect = false;
            } else {
                isCorrect = true; // Override if normalized strings match exactly
                feedback.length = 0; // Clear partial feedback
            }

            return { isCorrect, feedback };
        }

        function checkUserCode() {
            const userQuery = document.getElementById('user-query-area').value;
            const correctQuery = learningData[currentTopicIndex].questions[currentQuestionIndex].query;

            if (userQuery.trim() === '') {
                feedbackTitle.textContent = "Please enter a query.";
                feedbackList.innerHTML = "";
                feedbackContainer.className = 'incorrect';
                feedbackContainer.style.display = 'block';
                return;
            }

            const { isCorrect, feedback } = getAdvancedFeedback(userQuery, correctQuery);

            feedbackContainer.style.display = 'block';
            if (isCorrect) {
                feedbackTitle.textContent = "Excellent! Your query is correct.";
                feedbackList.innerHTML = "";
                feedbackContainer.className = 'correct';
            } else {
                feedbackTitle.textContent = "Here is an analysis of your query:";
                feedbackList.innerHTML = feedback.join('');
                feedbackContainer.className = 'incorrect';
            }
        }

        // --- Main Application Logic (loadTopics, loadQuestion, etc.) ---
        // This part is the same as the previous version. It handles the UI flow.
        const topicSelectionView = document.getElementById('topic-selection-view');
        const practiceView = document.getElementById('practice-view');
        const topicGrid = document.getElementById('topic-grid');
        const topicTitleEl = document.getElementById('topic-title');
        const schemaDisplayEl = document.getElementById('schema-display');
        const questionCounterEl = document.getElementById('question-counter');
        const taskDescEl = document.getElementById('task-description');
        const conceptsTextEl = document.getElementById('concepts-text');
        const userQueryArea = document.getElementById('user-query-area');
        const queryCodeEl = document.getElementById('query-code');
        const explanationTextEl = document.getElementById('explanation-text');
        
        let currentTopicIndex = 0;
        let currentQuestionIndex = 0;
        
        function showView(viewName) {
            topicSelectionView.style.display = 'none';
            practiceView.style.display = 'none';
            document.getElementById(viewName).style.display = 'block';
        }
        
        function loadQuestion() {
            const topic = learningData[currentTopicIndex];
            const question = topic.questions[currentQuestionIndex];
            
            document.getElementById('concepts-content').style.display = 'none';
            document.getElementById('answer-content').style.display = 'none';
            feedbackContainer.style.display = 'none';
            userQueryArea.value = '';

            topicTitleEl.textContent = topic.topic;
            schemaDisplayEl.textContent = topic.schema;
            conceptsTextEl.innerHTML = `<ul>${topic.concepts.map(c => `<li>${c}</li>`).join('')}</ul>`;
            questionCounterEl.textContent = `Question ${currentQuestionIndex + 1} of ${topic.questions.length}`;
            taskDescEl.textContent = question.task;
            queryCodeEl.textContent = question.query;
            explanationTextEl.textContent = `An INNER JOIN returns only the rows where the join condition is met in both tables. Here, it retrieves students who are enrolled in a course, matching \`students.course_id\` with \`courses.course_id\`.`;

            document.getElementById('prev-btn').style.visibility = currentQuestionIndex === 0 ? 'hidden' : 'visible';
            document.getElementById('next-btn').style.visibility = currentQuestionIndex === topic.questions.length - 1 ? 'hidden' : 'visible';
        }
        
        function loadTopics() {
            topicGrid.innerHTML = '';
            learningData.forEach((topicData, index) => {
                const card = document.createElement('div');
                card.className = 'topic-card';
                card.textContent = topicData.topic;
                card.dataset.index = index;
                card.addEventListener('click', () => {
                    currentTopicIndex = index;
                    currentQuestionIndex = 0;
                    loadQuestion();
                    showView('practice-view');
                });
                topicGrid.appendChild(card);
            });
            showView('topic-selection-view');
        }

        document.getElementById('toggle-concepts-btn').addEventListener('click', () => {
            const content = document.getElementById('concepts-content');
            content.style.display = content.style.display === 'block' ? 'none' : 'block';
        });
        document.getElementById('check-code-btn').addEventListener('click', checkUserCode);
        document.getElementById('reveal-answer-btn').addEventListener('click', () => {
            const content = document.getElementById('answer-content');
            content.style.display = content.style.display === 'block' ? 'none' : 'block';
        });
        document.getElementById('next-btn').addEventListener('click', () => {
            if (currentQuestionIndex < learningData[currentTopicIndex].questions.length - 1) {
                currentQuestionIndex++;
                loadQuestion();
            }
        });
        document.getElementById('prev-btn').addEventListener('click', () => {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                loadQuestion();
            }
        });
        document.getElementById('back-to-topics-btn').addEventListener('click', loadTopics);

        loadTopics(); // Initial call
    </script>
</body>
</html>
